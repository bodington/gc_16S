---
title: "Soil GC Fractions Community Diversity"
author: "Dylan Bodington"
date: "`r Sys.Date()`"
out:
  html_document:
    toc: true
    toc_depth: 2
    code_folding: hide
    fig_caption: true
    
citation_package: bibtex
bibliography: bib.bib
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2); theme_set(theme_light())
library(ggpubr)
library(ggsci)
library(tidyr)
library(stringr)
library(dplyr)
library(phyloseq)
library(microbiome)
library(speedyseq)
library(microViz)
library(metagMisc)

#library(devtools)
#source("./R/phyloseq_taxonomy_imputation.R")
```

## Introduction

After cleaning and filtering using trimgalore, the 16S were processed using the standard [dada2 pipeline](https://benjjneb.github.io/dada2/tutorial.html) to create phyloseq objects of all ASVs. When rdp cannot reliably assign taxonomy (in this case down to Genus), levels below the lowest reliable assignment are designated NA. [This script](https://github.com/bodington/gc_16S/blob/main/R/phyloseq_taxonomy_imputation.R) modifies the tax table of a phyloseq object to replace NA with the lowest assigned level + "_unidentified" eg "Bacteria, Cyanobacteria, Cyanobacteria_unidentified"


```{r ps_objects, message=FALSE, warning=FALSE, include=FALSE}
ps_16S <- readRDS('./02_out/phyloseq.Rds') %>%
  ps_arrange(source, fraction) %>%
  tax_fix()
#  phyloseq_taxonomy_imputation()
#  phyloseq_filter_taxa_rel_abund(frac = 0.00001)

sample_data(ps_16S)$labels <- read.csv(file = "00_ref/axis.labels.csv")[, c(13)]
```

## Alpha Diversity

```{r alpha_16S, fig.height=8, fig.width=12}
shannon_16S_plot <- plot_richness(ps_16S,
                                  x = "name",
                                  color = "soil",
                                  nrow = 4) +
  scale_x_discrete(labels = c(sample_data(ps_16S)$labels))
shannon_16S_plot$data$name <- factor(shannon_16S_plot$data$name, levels = str_sort(sample_data(ps_16S)$name, numeric = TRUE))
shannon_16S_plot$data$soil <- factor(shannon_16S_plot$data$soil, levels = c("Craibstone pH 4.5", "Craibstone pH 7.5", "Corsemaul", "Lower Dell"))
shannon_16S_plot
```
```{r}
ordcap = ordinate(ps_filter(ps_16S, GC != "NA"), "CAP", "bray", ~GC)
plot_ordination(ps_16S, ordcap, "samples", color="soil")
```

```{r shannon_16S, fig.height=4, fig.width=12}
ps_16S <- ps_filter(ps_16S, !(labels %in% c("Mixed", "Whole Replicate 2", "Whole Replicate 3")))
shannon_16S_plot <- plot_richness(ps_16S,
                                  x = 'name',
                                  measures=c("Shannon"),
                                  title = "Shannon Diversity of Soil Community Fractions") +
  facet_wrap(~soil,
             ncol = 4,
             scales="free_x") +
  scale_color_npg() +
  guides(colour = "none") +
  labs(x = "Sample",
       y = "Shannon Diversity") +
  theme(axis.text.x = element_text(angle = -90)) +
  scale_x_discrete(labels = c(sample_data(ps_16S)$labels))
shannon_16S_plot$data$name <- factor(shannon_16S_plot$data$name, levels = str_sort(sample_data(ps_16S)$name, numeric = TRUE))
shannon_16S_plot$data$soil <- factor(shannon_16S_plot$data$soil, levels = c("Craibstone pH 4.5", "Craibstone pH 7.5", "Corsemaul", "Lower Dell"))
shannon_16S_plot
```

## Community Composition

When displaying the taxonomic makeup of the communities at phylum level, I split Pseudomonadota into classes.

```{r proteobacteria_phylum, warning=FALSE}
ps_16S_proteo <- ps_16S

plot.tax <- as.data.frame(tax_table(ps_16S))
plot.tax <-  data.frame(lapply(plot.tax, as.character), stringsAsFactors = F)
plot.tax$Phylum[plot.tax$Phylum=="Proteobacteria"] = plot.tax$Class[plot.tax$Phylum=="Proteobacteria"] 
plot.tax[] = lapply(plot.tax, factor)
plot.tax.table = tax_table(plot.tax)
rownames(plot.tax.table) = rownames(tax_table(ps_16S))
colnames(plot.tax.table) = colnames(tax_table(ps_16S))

tax_table(ps_16S_proteo) = plot.tax.table
phylum_levels <- append(levels(factor(tax_table(ps_16S_proteo)[,"Phylum"])), "Other")
rm(list = c("plot.tax" , "plot.tax.table"))
```

```{r phylum_relabund, fig.height=6, fig.width=20}
write.table(tax_glom(ps_16S_proteo, taxrank = "Phylum", bad_empty = "Bacteria_unidentified") %>%
              psmelt() %>%
              select(Phylum, Sample, Abundance) %>%
              spread(Sample, Abundance),
            file = "./02_out/ps_16S.relative_abundance.phylum.csv",
            sep = ",",
            quote = F,
            row.names = F,
            col.names = T
            )

ps <- ps_16S_proteo %>%
  transform_sample_counts(function(x) x / sum(x)) %>%
  tax_glom(taxrank = "Phylum", bad_empty = "Bacteria_unidentified") %>%
  aggregate_rare("Phylum", detection = 0.05, prevalence = 0.05)
#  transform_sample_counts(function(x) x * 100)

taxa_16S_plot <- plot_bar(ps,
                          x = "name", 
                          fill="Phylum") +
  facet_wrap(~soil,
             ncol = 4,
             scales="free_x") +
  labs(fill = "Phylum",
       y = "Relative Abundance") +
  theme() +
  scale_x_discrete(labels = c(sample_data(ps_16S)$labels)) +
  scale_fill_simpsons()+
  guides(fill = guide_legend(ncol = 1))
taxa_16S_plot$data$name <- factor(taxa_16S_plot$data$name, levels = str_sort(sample_data(ps_16S)$name, numeric = TRUE))
taxa_16S_plot$data$soil <- factor(taxa_16S_plot$data$soil, levels = c("Craibstone pH 4.5", "Craibstone pH 7.5", "Corsemaul", "Lower Dell"))
taxa_16S_plot$data$Phylum <- factor(taxa_16S_plot$data$Phylum, levels = phylum_levels)
taxa_16S_plot$layers[[1]]$geom_params$width <- 1
taxa_16S_plot
```

Filler

## Plots for publication

Download links below plot

### Fig 1

```{r pub_fig_1, fig.height=6, fig.width=12}
zp1 <- shannon_16S_plot +
  scale_y_continuous(limits = c(4.2, 6.8),
                     breaks = c(5, 6)) +
  labs(title = "Catchy Graph Title A",
       y = "H") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(face = "italic"),
        strip.text = element_text(size = 12),
        plot.margin = unit(c(1,1,-0.1,1), "lines"))
zp2 <- taxa_16S_plot +
  guides(fill = guide_legend(nrow = 2)) +
  labs(x = "Sample",
       y = "Relative Abundance",
       legend = "Phylum") +
  theme(strip.text.x = element_blank(),
        legend.position = "bottom",
        plot.margin = unit(c(-0.1,1,1,1), "lines"))
zp <- ggarrange(zp1, zp2,
          nrow = 2,
          heights = c(0.22,1),
          align = "v")
zp
ggplot2::ggsave(zp, file = "./02_out/01_alpha_diversity.png")
```

[Download this plot.](https://github.com/bodington/gc_16S/raw/main/02_out/01_alpha_diversity.png)
